<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TyphoonX Signup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; padding: 24px; }
    form { max-width: 420px; }
    label { display: block; margin: 12px 0 6px; }
    input { width: 100%; padding: 10px; box-sizing: border-box; }
    button { margin-top: 16px; padding: 10px 14px; }
    .msg { margin-top: 12px; }
    .error { color: #c0392b; }
    .success { color: #1b7f3f; }
  </style>
</head>
<body>
  <h3>Create your TyphoonX account</h3>
  <form id="signup-form" novalidate>
    <label for="email">Email</label>
    <input id="email" name="email" type="email" placeholder="you@example.com" required>

    <label for="password">Password</label>
    <input id="password" name="password" type="password" minlength="6" required>

    <label for="confirm">Confirm Password</label>
    <input id="confirm" name="confirm" type="password" minlength="6" required>

    <button id="submit-btn" type="submit">Sign up</button>
    <div class="msg" id="msg"></div>
  </form>

  <script>
    /**
     * 前端配置：请将下方 URL 替换为你 Supabase Edge Function 的真实地址。
     * 例： https://<YOUR_PROJECT_REF>.functions.supabase.co/signup
     * 你也可以将其放入 <script> 注入的全局变量中以便不同环境切换。
     * @type {string}
     */
    const SUPABASE_FUNCTION_URL = 'https://potpgjiuqimpbrhdafnz.supabase.co/functions/v1/user_signup';
    /** @type {string} 允许的邮箱域名 */
    const ALLOWED_DOMAIN = 'wapitee.io';

    /**
     * 简单的邮箱格式校验
     * @param {string} value
     * @returns {boolean}
     */
    function isValidEmail(value) {
      return /.+@.+\..+/.test(value);
    }

    /**
     * 检查邮箱是否属于允许的域名
     * @param {string} value
     * @param {string} allowedDomain
     * @returns {boolean}
     */
    function isAllowedDomain(value, allowedDomain) {
      const at = value.lastIndexOf('@');
      if (at < 0) return false;
      const domain = value.slice(at + 1).toLowerCase();
      return domain === allowedDomain.toLowerCase();
    }

    /**
     * 显示消息
     * @param {string} text
     * @param {'error'|'success'} type
     * @returns {void}
     */
    function showMessage(text, type) {
      const el = document.getElementById('msg');
      el.textContent = text;
      el.className = `msg ${type}`;
    }

    /**
     * 绑定提交事件
     * @returns {void}
     */
    (function bindForm() {
      const form = document.getElementById('signup-form');
      const submitBtn = document.getElementById('submit-btn');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        showMessage('', 'success');

        const email = /** @type {HTMLInputElement} */ (document.getElementById('email')).value.trim();
        const password = /** @type {HTMLInputElement} */ (document.getElementById('password')).value;
        const confirm = /** @type {HTMLInputElement} */ (document.getElementById('confirm')).value;

        if (!isValidEmail(email)) {
          showMessage('请输入有效的邮箱地址。', 'error');
          return;
        }
        if (!isAllowedDomain(email, ALLOWED_DOMAIN)) {
          showMessage('目前仅支持使用 @wapitee.io 邮箱注册。', 'error');
          return;
        }
        if (password.length < 6) {
          showMessage('密码长度至少为 6 位。', 'error');
          return;
        }
        if (password !== confirm) {
          showMessage('两次密码输入不一致。', 'error');
          return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        try {
          const res = await fetch(SUPABASE_FUNCTION_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            showMessage(data?.error || '注册失败，请稍后重试。', 'error');
          } else {
            showMessage('注册成功，请检查邮箱以完成验证（若已启用）。', 'success');
            form.reset();
          }
        } catch (err) {
          showMessage('网络错误，请稍后重试。', 'error');
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Sign up';
        }
      });
    })();
  </script>
</body>
</html>

